<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizations - OpenSwiss.info</title>
    <meta name="description" content="Interactive visualizations of Swiss open data - transport networks, real-time statistics, and more">
    <link rel="stylesheet" href="styles.css">

    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo">open <span class="swiss">swiss</span> info</div>
                <div class="language-bar">
                    <div class="language-links">
                        <a href="#de">DE</a>
                        <span>|</span>
                        <a href="#fr">FR</a>
                        <span>|</span>
                        <a href="#it">IT</a>
                        <span>|</span>
                        <a href="#en" class="active">EN</a>
                    </div>
                </div>
            </div>
            <nav class="nav">
                <div class="nav-item">
                    <a href="index.html">home</a>
                </div>
                <div class="nav-item">
                    <a href="#about">about</a>
                </div>
                <div class="nav-item">
                    <a href="#place">place</a>
                    <div class="dropdown">
                        <a href="#canton-lucerne">Canton of Lucerne</a>
                        <a href="#lucerne-city" style="padding-left: 32px;">Lucerne (city)</a>
                        <a href="#kriens" style="padding-left: 32px;">Kriens</a>
                        <a href="#emmen" style="padding-left: 32px;">Emmen</a>
                        <a href="#canton-nidwalden">Canton of Nidwalden</a>
                    </div>
                </div>
                <div class="nav-item">
                    <a href="#data">data</a>
                    <div class="dropdown">
                        <a href="#demographics">demographics</a>
                        <a href="#politics">politics</a>
                        <a href="#culture">culture</a>
                        <a href="#economy">economy</a>
                        <a href="#geography">geography</a>
                        <a href="#education">education</a>
                        <a href="#healthcare">healthcare</a>
                        <a href="#environment">environment</a>
                    </div>
                </div>
                <div class="nav-item">
                    <a href="visualizations.html" class="active">visualizations</a>
                    <div class="dropdown">
                        <a href="visualizations.html">rail</a>
                        <a href="traffic.html">road</a>
                    </div>
                </div>
                <div class="nav-item">
                    <a href="weather.html">weather</a>
                </div>
                <div class="nav-item">
                    <a href="#contact">contact</a>
                </div>
            </nav>
        </header>

        <div class="graph-panel">
            <h2 class="panel-title">Select City</h2>
            <div class="data-controls">
                <div class="control-group">
                    <select id="city-selector" class="control-input">
                        <option value="">Select a city...</option>
                        <option value="Zürich">Zürich</option>
                        <option value="Bern">Bern</option>
                        <option value="Genève">Genève</option>
                        <option value="Basel">Basel</option>
                        <option value="Lausanne">Lausanne</option>
                        <option value="Luzern">Luzern</option>
                        <option value="St. Gallen">St. Gallen</option>
                        <option value="Lugano">Lugano</option>
                        <option value="Winterthur">Winterthur</option>
                        <option value="Thun">Thun</option>
                        <option value="Interlaken">Interlaken</option>
                        <option value="Montreux">Montreux</option>
                    </select>
                </div>
            </div>

            <h2 class="panel-title" style="margin-top: 24px;">How to Use</h2>
            <div style="font-size: 12px; line-height: 1.6; color: #333;">
                <p style="margin-bottom: 8px;"><strong>Click</strong> on any city to view real-time train departures</p>
                <p style="margin-bottom: 8px;"><strong>Drag</strong> nodes to rearrange the network</p>
                <p style="margin-bottom: 8px;">Node size indicates city importance as transport hub</p>
                <p>Lines show major train connections</p>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <h1 class="chat-title">Swiss Transport Network</h1>
                <p class="chat-subtitle">Interactive visualization of real-time Swiss public transport connections</p>
            </div>

            <div id="transport-graph" style="height: 600px; position: relative;">
                <svg id="network-svg" style="width: 100%; height: 100%; background: #fafafa; border: 1px solid #e0e0e0;"></svg>
                <div id="loading-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 8px;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Loading Swiss transport network...</div>
                    <div style="font-size: 12px; color: #999;">Connecting to real-time data</div>
                </div>
            </div>
        </div>

        <div class="citations-panel">
            <h2 class="panel-title">Live Departures</h2>
            <div id="station-info" style="background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px; min-height: 200px; font-size: 13px; color: #666; margin-bottom: 24px;">
                Click on a city to view real-time train departures
            </div>

            <h2 class="panel-title">Data Sources</h2>
            <div class="citations-list">
                <div class="citation">
                    <div class="citation-number">[1]</div>
                    <div class="citation-title"><a href="https://transport.opendata.ch/" target="_blank">Swiss Transport API</a></div>
                    <div class="citation-source">transport.opendata.ch</div>
                    <div class="citation-excerpt">Real-time Swiss public transport data providing live timetable information, connections, and stationboard data across Switzerland.</div>
                </div>

                <div class="citation">
                    <div class="citation-number">[2]</div>
                    <div class="citation-title"><a href="https://opendata.swiss/en" target="_blank">opendata.swiss</a></div>
                    <div class="citation-source">Swiss Federal Government</div>
                    <div class="citation-excerpt">Central portal for open government data from the Swiss public administration, providing access to thousands of datasets.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Swiss Transport Network Visualization
        const API_BASE = 'https://transport.opendata.ch/v1';

        // Major Swiss cities with their main stations
        // Positioned to reflect actual Swiss geography
        const swissCities = [
            { id: 'zurich', name: 'Zürich', station: 'Zürich HB', importance: 10, x: 650, y: 200 },
            { id: 'bern', name: 'Bern', station: 'Bern', importance: 9, x: 400, y: 280 },
            { id: 'geneva', name: 'Genève', station: 'Genève', importance: 9, x: 120, y: 380 },
            { id: 'basel', name: 'Basel', station: 'Basel SBB', importance: 8, x: 280, y: 150 },
            { id: 'lausanne', name: 'Lausanne', station: 'Lausanne', importance: 7, x: 200, y: 400 },
            { id: 'luzern', name: 'Luzern', station: 'Luzern', importance: 6, x: 520, y: 320 },
            { id: 'stgallen', name: 'St. Gallen', station: 'St. Gallen', importance: 6, x: 850, y: 160 },
            { id: 'lugano', name: 'Lugano', station: 'Lugano', importance: 5, x: 680, y: 600 },
            { id: 'winterthur', name: 'Winterthur', station: 'Winterthur', importance: 5, x: 720, y: 180 },
            { id: 'thun', name: 'Thun', station: 'Thun', importance: 4, x: 420, y: 350 },
            { id: 'interlaken', name: 'Interlaken', station: 'Interlaken Ost', importance: 4, x: 450, y: 480 },
            { id: 'montreux', name: 'Montreux', station: 'Montreux', importance: 4, x: 230, y: 430 }
        ];

        // Define major connections between Swiss cities
        const connections = [
            { source: 'zurich', target: 'bern' },
            { source: 'zurich', target: 'basel' },
            { source: 'zurich', target: 'luzern' },
            { source: 'zurich', target: 'winterthur' },
            { source: 'zurich', target: 'stgallen' },
            { source: 'bern', target: 'basel' },
            { source: 'bern', target: 'lausanne' },
            { source: 'bern', target: 'thun' },
            { source: 'bern', target: 'luzern' },
            { source: 'geneva', target: 'lausanne' },
            { source: 'lausanne', target: 'montreux' },
            { source: 'lausanne', target: 'bern' },
            { source: 'basel', target: 'zurich' },
            { source: 'basel', target: 'bern' },
            { source: 'luzern', target: 'zurich' },
            { source: 'luzern', target: 'interlaken' },
            { source: 'thun', target: 'interlaken' },
            { source: 'lugano', target: 'luzern' },
            { source: 'stgallen', target: 'winterthur' }
        ];

        // Setup SVG with responsive dimensions
        const container = document.getElementById('transport-graph');
        const svg = d3.select('#network-svg');
        const width = container.offsetWidth || 700;
        const height = 600;

        svg.attr('width', width).attr('height', height);

        // Create color scale based on importance
        const colorScale = d3.scaleSequential(d3.interpolateReds)
            .domain([3, 10]);

        // Initialize positions based on geography
        swissCities.forEach(city => {
            // Scale positions if screen is smaller
            const scale = Math.min(width / 1000, 1);
            city.x = city.x * scale;
            city.y = city.y;
        });

        // Create force simulation with weaker forces to maintain geographic layout
        const simulation = d3.forceSimulation(swissCities)
            .force('link', d3.forceLink(connections)
                .id(d => d.id)
                .distance(d => {
                    // Calculate actual distance between cities to maintain proportions
                    const source = swissCities.find(c => c.id === d.source.id || c.id === d.source);
                    const target = swissCities.find(c => c.id === d.target.id || c.id === d.target);
                    const dx = source.x - target.x;
                    const dy = source.y - target.y;
                    return Math.sqrt(dx * dx + dy * dy) * 0.8;
                })
                .strength(0.3))
            .force('charge', d3.forceManyBody().strength(-100))
            .force('collision', d3.forceCollide().radius(35))
            .alphaDecay(0.05);

        // Create links
        const link = svg.append('g')
            .selectAll('line')
            .data(connections)
            .join('line')
            .attr('stroke', '#999')
            .attr('stroke-opacity', 0.6)
            .attr('stroke-width', 3);

        // Create nodes
        const node = svg.append('g')
            .selectAll('circle')
            .data(swissCities)
            .join('circle')
            .attr('r', d => 5 + d.importance * 1.5)
            .attr('fill', d => colorScale(d.importance))
            .attr('stroke', '#fff')
            .attr('stroke-width', 3)
            .style('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // Add labels
        const labels = svg.append('g')
            .selectAll('text')
            .data(swissCities)
            .join('text')
            .text(d => d.name)
            .attr('font-size', '14px')
            .attr('font-weight', '500')
            .attr('dx', d => 8 + d.importance * 1.5)
            .attr('dy', 5)
            .attr('fill', '#1a1a1a')
            .style('pointer-events', 'none');

        // Update positions on simulation tick
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            labels
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Click on node to show station info
        node.on('click', async (event, d) => {
            event.stopPropagation();
            showStationInfo(d.station, d.name);

            // Highlight selected node
            node.attr('stroke-width', n => n === d ? 5 : 3);
        });

        // Fetch and display station info
        async function showStationInfo(station, cityName) {
            const infoDiv = document.getElementById('station-info');
            infoDiv.innerHTML = `<div style="color: #666; font-style: italic;">Loading departures from ${cityName}...</div>`;

            try {
                const response = await fetch(`${API_BASE}/stationboard?station=${encodeURIComponent(station)}&limit=5`);
                const data = await response.json();

                if (data.stationboard && data.stationboard.length > 0) {
                    let html = `<div style="font-weight: 700; font-size: 14px; color: #1a1a1a; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #dc2626;">${cityName}</div>`;
                    data.stationboard.slice(0, 5).forEach(departure => {
                        const time = new Date(departure.stop.departure).toLocaleTimeString('de-CH', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const category = departure.category || '';
                        const number = departure.number || '';
                        html += `
                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-left: 3px solid #dc2626; font-size: 12px;">
                                <div style="font-weight: 700; color: #1a1a1a;">${time}</div>
                                <div style="color: #666; font-size: 11px;">${category} ${number}</div>
                                <div style="color: #333;">→ ${departure.to || 'N/A'}</div>
                            </div>
                        `;
                    });
                    infoDiv.innerHTML = html;
                } else {
                    infoDiv.innerHTML = `<div style="color: #999; font-style: italic;">No departures available for ${cityName}</div>`;
                }
            } catch (error) {
                console.error('Error fetching station data:', error);
                infoDiv.innerHTML = `<div style="color: #dc2626;">Could not load data for ${cityName}</div>`;
            }
        }

        // City selector
        document.getElementById('city-selector').addEventListener('change', (e) => {
            const cityName = e.target.value;
            if (cityName) {
                const city = swissCities.find(c => c.name === cityName);
                if (city) {
                    showStationInfo(city.station, city.name);
                    node.attr('stroke-width', n => n.name === cityName ? 5 : 3);
                }
            }
        });

        // Hide loading indicator after simulation starts
        setTimeout(() => {
            document.getElementById('loading-indicator').style.display = 'none';
        }, 1000);

        // Responsive resize
        window.addEventListener('resize', () => {
            const newWidth = container.offsetWidth || 700;
            svg.attr('width', newWidth);
            // Recalculate city positions for new width
            const scale = Math.min(newWidth / 1000, 1);
            swissCities.forEach(city => {
                if (city.fx) city.fx = city.fx; // Keep fixed positions
                if (city.fy) city.fy = city.fy;
            });
        });
    </script>
</body>
</html>
